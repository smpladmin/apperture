from datetime import datetime
from unittest.mock import MagicMock
from models.models import ClickStream, PrecisionEvent
from server import save_events, app, save_precision_events


class TestServer:
    def setup_method(self):
        app.clickhouse = MagicMock()
        self.events = [
            {
                "event": "$autocapture",
                "properties": {
                    "$os": "Mac OS X",
                    "$browser": "Chrome",
                    "$device_type": "Desktop",
                    "$current_url": "https://app.staging.apperture.io/analytics/explore/63eb4eea19c763c212bc444d",
                    "$host": "app.staging.apperture.io",
                    "$pathname": "/analytics/explore/63eb4eea19c763c212bc444d",
                    "$browser_version": 112,
                    "$browser_language": "en-GB",
                    "$screen_height": 982,
                    "$screen_width": 1512,
                    "$viewport_height": 560,
                    "$viewport_width": 1512,
                    "$lib": "web",
                    "$lib_version": "1.50.4",
                    "$insert_id": "z0mm9dj9ns9eltcw",
                    "$time": 1681714333.385,
                    "distinct_id": "631821697fb64164bfa6609e",
                    "$device_id": "1876b24aecbe52-0fd97ea66a2cdf-1e525634-16a7f0-1876b24aecc171f",
                    "$referrer": "$direct",
                    "$referring_domain": "$direct",
                    "$user_id": "631821697fb64164bfa6609e",
                    "$event_type": "click",
                    "$ce_version": 1,
                    "$elements": [
                        {
                            "tag_name": "i",
                            "classes": ["ri-newspaper-line"],
                            "attr__class": "ri-newspaper-line",
                            "attr__aria-hidden": "true",
                            "attr__focusable": "false",
                            "nth_child": 1,
                            "nth_of_type": 1,
                            "$el_text": "",
                        },
                        {
                            "tag_name": "button",
                            "$el_text": "",
                            "classes": ["chakra-button", "css-vyn3p3"],
                            "attr__type": "button",
                            "attr__class": "chakra-button css-vyn3p3",
                            "attr__aria-label": "Data Stream",
                            "attr__aria-describedby": "tooltip-:re:",
                            "nth_child": 11,
                            "nth_of_type": 7,
                        },
                        {
                            "tag_name": "div",
                            "classes": ["css-g1rznr"],
                            "attr__class": "css-g1rznr",
                            "nth_child": 1,
                            "nth_of_type": 1,
                        },
                        {
                            "tag_name": "div",
                            "classes": ["css-87dp0f"],
                            "attr__class": "css-87dp0f",
                            "nth_child": 3,
                            "nth_of_type": 3,
                        },
                        {
                            "tag_name": "div",
                            "classes": ["css-3h169z"],
                            "attr__class": "css-3h169z",
                            "nth_child": 1,
                            "nth_of_type": 1,
                        },
                        {
                            "tag_name": "div",
                            "classes": ["css-1xhj18k"],
                            "attr__class": "css-1xhj18k",
                            "nth_child": 2,
                            "nth_of_type": 1,
                        },
                        {
                            "tag_name": "div",
                            "attr__id": "__next",
                            "nth_child": 1,
                            "nth_of_type": 1,
                        },
                        {
                            "tag_name": "body",
                            "classes": ["chakra-ui-light"],
                            "attr__class": "chakra-ui-light",
                            "nth_child": 2,
                            "nth_of_type": 1,
                        },
                    ],
                    "token": "63eb4eea19c763c212bc444d",
                    "$session_id": "1878de47cc337dd-0ff3158333e013-1d525634-16a7f0-1878de47cc44210",
                    "$window_id": "1878df92f1428bf-0a01a1b024ea9d-1d525634-16a7f0-1878df92f153e7b",
                    "$pageview_id": "1878dfc3d441a2f-0321ef1c72bcde-1d525634-16a7f0-1878dfc3d454b62",
                },
                "offset": 1060,
            },
            {
                "event": "$pageleave",
                "properties": {
                    "$os": "Mac OS X",
                    "$browser": "Chrome",
                    "$device_type": "Desktop",
                    "$current_url": "https://app.staging.apperture.io/analytics/explore/63eb4eea19c763c212bc444d",
                    "$host": "app.staging.apperture.io",
                    "$pathname": "/analytics/explore/63eb4eea19c763c212bc444d",
                    "$browser_version": 112,
                    "$browser_language": "en-GB",
                    "$screen_height": 982,
                    "$screen_width": 1512,
                    "$viewport_height": 560,
                    "$viewport_width": 1512,
                    "$lib": "web",
                    "$lib_version": "1.50.4",
                    "$insert_id": "ph5rf1hs52ji9qgg",
                    "$time": 1681714333.388,
                    "distinct_id": "631821697fb64164bfa6609e",
                    "$device_id": "1876b24aecbe52-0fd97ea66a2cdf-1e525634-16a7f0-1876b24aecc171f",
                    "$referrer": "$direct",
                    "$referring_domain": "$direct",
                    "$user_id": "631821697fb64164bfa6609e",
                    "token": "63eb4eea19c763c212bc444d",
                    "$session_id": "1878de47cc337dd-0ff3158333e013-1d525634-16a7f0-1878de47cc44210",
                    "$window_id": "1878df92f1428bf-0a01a1b024ea9d-1d525634-16a7f0-1878df92f153e7b",
                    "$pageview_id": "1878dfc3d441a2f-0321ef1c72bcde-1d525634-16a7f0-1878dfc3d454b62",
                },
                "offset": 1057,
            },
            {
                "event": "$pageview",
                "properties": {
                    "$os": "Mac OS X",
                    "$browser": "Chrome",
                    "$device_type": "Desktop",
                    "$current_url": "https://app.staging.apperture.io/analytics/data/stream/63eb4eea19c763c212bc444d",
                    "$host": "app.staging.apperture.io",
                    "$pathname": "/analytics/data/stream/63eb4eea19c763c212bc444d",
                    "$browser_version": 112,
                    "$browser_language": "en-GB",
                    "$screen_height": 982,
                    "$screen_width": 1512,
                    "$viewport_height": 560,
                    "$viewport_width": 1512,
                    "$lib": "web",
                    "$lib_version": "1.50.4",
                    "$insert_id": "d3l8005xq80sysch",
                    "$time": 1681714333.495,
                    "distinct_id": "631821697fb64164bfa6609e",
                    "$device_id": "1876b24aecbe52-0fd97ea66a2cdf-1e525634-16a7f0-1876b24aecc171f",
                    "$referrer": "$direct",
                    "$referring_domain": "$direct",
                    "$user_id": "631821697fb64164bfa6609e",
                    "token": "63eb4eea19c763c212bc444d",
                    "$session_id": "1878de47cc337dd-0ff3158333e013-1d525634-16a7f0-1878de47cc44210",
                    "$window_id": "1878df92f1428bf-0a01a1b024ea9d-1d525634-16a7f0-1878df92f153e7b",
                    "$pageview_id": "1878dfc4737114e-08cffb238cfcc7-1d525634-16a7f0-1878dfc47382a0d",
                },
                "offset": 948,
            },
        ]

    def test_save_events(self):
        save_events(self.events)

        app.clickhouse.save_events.assert_called_once_with(
            [
                ClickStream(
                    datasourceId="63eb4eea19c763c212bc444d",
                    timestamp=datetime.fromtimestamp(1681714333.385),
                    userId="1876b24aecbe52-0fd97ea66a2cdf-1e525634-16a7f0-1876b24aecc171f",
                    element_chain='i.ri-newspaper-line:nth-child="1"nth-of-type="1";button.chakra-button.css-vyn3p3:nth-child="11"nth-of-type="7";div.css-g1rznr:nth-child="1"nth-of-type="1";div.css-87dp0f:nth-child="3"nth-of-type="3";div.css-3h169z:nth-child="1"nth-of-type="1";div.css-1xhj18k:nth-child="2"nth-of-type="1";div:attr_id="__next"nth-child="1"nth-of-type="1";body.chakra-ui-light:nth-child="2"nth-of-type="1"',
                    event="$autocapture",
                    properties={
                        "$os": "Mac OS X",
                        "$browser": "Chrome",
                        "$device_type": "Desktop",
                        "$current_url": "https://app.staging.apperture.io/analytics/explore/63eb4eea19c763c212bc444d",
                        "$host": "app.staging.apperture.io",
                        "$pathname": "/analytics/explore/63eb4eea19c763c212bc444d",
                        "$browser_version": 112,
                        "$browser_language": "en-GB",
                        "$screen_height": 982,
                        "$screen_width": 1512,
                        "$viewport_height": 560,
                        "$viewport_width": 1512,
                        "$lib": "web",
                        "$lib_version": "1.50.4",
                        "$insert_id": "z0mm9dj9ns9eltcw",
                        "$time": 1681714333.385,
                        "distinct_id": "631821697fb64164bfa6609e",
                        "$device_id": "1876b24aecbe52-0fd97ea66a2cdf-1e525634-16a7f0-1876b24aecc171f",
                        "$referrer": "$direct",
                        "$referring_domain": "$direct",
                        "$user_id": "631821697fb64164bfa6609e",
                        "$event_type": "click",
                        "$ce_version": 1,
                        "$elements": [
                            {
                                "tag_name": "i",
                                "classes": ["ri-newspaper-line"],
                                "attr__class": "ri-newspaper-line",
                                "attr__aria-hidden": "true",
                                "attr__focusable": "false",
                                "nth_child": 1,
                                "nth_of_type": 1,
                                "$el_text": "",
                            },
                            {
                                "tag_name": "button",
                                "$el_text": "",
                                "classes": ["chakra-button", "css-vyn3p3"],
                                "attr__type": "button",
                                "attr__class": "chakra-button css-vyn3p3",
                                "attr__aria-label": "Data Stream",
                                "attr__aria-describedby": "tooltip-:re:",
                                "nth_child": 11,
                                "nth_of_type": 7,
                            },
                            {
                                "tag_name": "div",
                                "classes": ["css-g1rznr"],
                                "attr__class": "css-g1rznr",
                                "nth_child": 1,
                                "nth_of_type": 1,
                            },
                            {
                                "tag_name": "div",
                                "classes": ["css-87dp0f"],
                                "attr__class": "css-87dp0f",
                                "nth_child": 3,
                                "nth_of_type": 3,
                            },
                            {
                                "tag_name": "div",
                                "classes": ["css-3h169z"],
                                "attr__class": "css-3h169z",
                                "nth_child": 1,
                                "nth_of_type": 1,
                            },
                            {
                                "tag_name": "div",
                                "classes": ["css-1xhj18k"],
                                "attr__class": "css-1xhj18k",
                                "nth_child": 2,
                                "nth_of_type": 1,
                            },
                            {
                                "tag_name": "div",
                                "attr__id": "__next",
                                "nth_child": 1,
                                "nth_of_type": 1,
                            },
                            {
                                "tag_name": "body",
                                "classes": ["chakra-ui-light"],
                                "attr__class": "chakra-ui-light",
                                "nth_child": 2,
                                "nth_of_type": 1,
                            },
                        ],
                        "token": "63eb4eea19c763c212bc444d",
                        "$session_id": "1878de47cc337dd-0ff3158333e013-1d525634-16a7f0-1878de47cc44210",
                        "$window_id": "1878df92f1428bf-0a01a1b024ea9d-1d525634-16a7f0-1878df92f153e7b",
                        "$pageview_id": "1878dfc3d441a2f-0321ef1c72bcde-1d525634-16a7f0-1878dfc3d454b62",
                    },
                ),
                ClickStream(
                    datasourceId="63eb4eea19c763c212bc444d",
                    timestamp=datetime.fromtimestamp(1681714333.388),
                    userId="1876b24aecbe52-0fd97ea66a2cdf-1e525634-16a7f0-1876b24aecc171f",
                    element_chain="",
                    event="$pageleave",
                    properties={
                        "$os": "Mac OS X",
                        "$browser": "Chrome",
                        "$device_type": "Desktop",
                        "$current_url": "https://app.staging.apperture.io/analytics/explore/63eb4eea19c763c212bc444d",
                        "$host": "app.staging.apperture.io",
                        "$pathname": "/analytics/explore/63eb4eea19c763c212bc444d",
                        "$browser_version": 112,
                        "$browser_language": "en-GB",
                        "$screen_height": 982,
                        "$screen_width": 1512,
                        "$viewport_height": 560,
                        "$viewport_width": 1512,
                        "$lib": "web",
                        "$lib_version": "1.50.4",
                        "$insert_id": "ph5rf1hs52ji9qgg",
                        "$time": 1681714333.388,
                        "distinct_id": "631821697fb64164bfa6609e",
                        "$device_id": "1876b24aecbe52-0fd97ea66a2cdf-1e525634-16a7f0-1876b24aecc171f",
                        "$referrer": "$direct",
                        "$referring_domain": "$direct",
                        "$user_id": "631821697fb64164bfa6609e",
                        "token": "63eb4eea19c763c212bc444d",
                        "$session_id": "1878de47cc337dd-0ff3158333e013-1d525634-16a7f0-1878de47cc44210",
                        "$window_id": "1878df92f1428bf-0a01a1b024ea9d-1d525634-16a7f0-1878df92f153e7b",
                        "$pageview_id": "1878dfc3d441a2f-0321ef1c72bcde-1d525634-16a7f0-1878dfc3d454b62",
                    },
                ),
                ClickStream(
                    datasourceId="63eb4eea19c763c212bc444d",
                    timestamp=datetime.fromtimestamp(1681714333.495),
                    userId="1876b24aecbe52-0fd97ea66a2cdf-1e525634-16a7f0-1876b24aecc171f",
                    element_chain="",
                    event="$pageview",
                    properties={
                        "$os": "Mac OS X",
                        "$browser": "Chrome",
                        "$device_type": "Desktop",
                        "$current_url": "https://app.staging.apperture.io/analytics/data/stream/63eb4eea19c763c212bc444d",
                        "$host": "app.staging.apperture.io",
                        "$pathname": "/analytics/data/stream/63eb4eea19c763c212bc444d",
                        "$browser_version": 112,
                        "$browser_language": "en-GB",
                        "$screen_height": 982,
                        "$screen_width": 1512,
                        "$viewport_height": 560,
                        "$viewport_width": 1512,
                        "$lib": "web",
                        "$lib_version": "1.50.4",
                        "$insert_id": "d3l8005xq80sysch",
                        "$time": 1681714333.495,
                        "distinct_id": "631821697fb64164bfa6609e",
                        "$device_id": "1876b24aecbe52-0fd97ea66a2cdf-1e525634-16a7f0-1876b24aecc171f",
                        "$referrer": "$direct",
                        "$referring_domain": "$direct",
                        "$user_id": "631821697fb64164bfa6609e",
                        "token": "63eb4eea19c763c212bc444d",
                        "$session_id": "1878de47cc337dd-0ff3158333e013-1d525634-16a7f0-1878de47cc44210",
                        "$window_id": "1878df92f1428bf-0a01a1b024ea9d-1d525634-16a7f0-1878df92f153e7b",
                        "$pageview_id": "1878dfc4737114e-08cffb238cfcc7-1d525634-16a7f0-1878dfc47382a0d",
                    },
                ),
            ]
        )

    def test_save_events(self):
        save_precision_events(self.events)

        app.clickhouse.save_precision_events.assert_called_once_with(
            [
                PrecisionEvent(
                    datasourceId="63eb4eea19c763c212bc444d",
                    timestamp=datetime.fromtimestamp(1681714333.385),
                    userId="1876b24aecbe52-0fd97ea66a2cdf-1e525634-16a7f0-1876b24aecc171f",
                    provider="apperture",
                    eventName="$autocapture",
                    properties={
                        "$os": "Mac OS X",
                        "$browser": "Chrome",
                        "$device_type": "Desktop",
                        "$current_url": "https://app.staging.apperture.io/analytics/explore/63eb4eea19c763c212bc444d",
                        "$host": "app.staging.apperture.io",
                        "$pathname": "/analytics/explore/63eb4eea19c763c212bc444d",
                        "$browser_version": 112,
                        "$browser_language": "en-GB",
                        "$screen_height": 982,
                        "$screen_width": 1512,
                        "$viewport_height": 560,
                        "$viewport_width": 1512,
                        "$lib": "web",
                        "$lib_version": "1.50.4",
                        "$insert_id": "z0mm9dj9ns9eltcw",
                        "$time": 1681714333.385,
                        "distinct_id": "631821697fb64164bfa6609e",
                        "$device_id": "1876b24aecbe52-0fd97ea66a2cdf-1e525634-16a7f0-1876b24aecc171f",
                        "$referrer": "$direct",
                        "$referring_domain": "$direct",
                        "$user_id": "631821697fb64164bfa6609e",
                        "$event_type": "click",
                        "$ce_version": 1,
                        "$elements": [
                            {
                                "tag_name": "i",
                                "classes": ["ri-newspaper-line"],
                                "attr__class": "ri-newspaper-line",
                                "attr__aria-hidden": "true",
                                "attr__focusable": "false",
                                "nth_child": 1,
                                "nth_of_type": 1,
                                "$el_text": "",
                            },
                            {
                                "tag_name": "button",
                                "$el_text": "",
                                "classes": ["chakra-button", "css-vyn3p3"],
                                "attr__type": "button",
                                "attr__class": "chakra-button css-vyn3p3",
                                "attr__aria-label": "Data Stream",
                                "attr__aria-describedby": "tooltip-:re:",
                                "nth_child": 11,
                                "nth_of_type": 7,
                            },
                            {
                                "tag_name": "div",
                                "classes": ["css-g1rznr"],
                                "attr__class": "css-g1rznr",
                                "nth_child": 1,
                                "nth_of_type": 1,
                            },
                            {
                                "tag_name": "div",
                                "classes": ["css-87dp0f"],
                                "attr__class": "css-87dp0f",
                                "nth_child": 3,
                                "nth_of_type": 3,
                            },
                            {
                                "tag_name": "div",
                                "classes": ["css-3h169z"],
                                "attr__class": "css-3h169z",
                                "nth_child": 1,
                                "nth_of_type": 1,
                            },
                            {
                                "tag_name": "div",
                                "classes": ["css-1xhj18k"],
                                "attr__class": "css-1xhj18k",
                                "nth_child": 2,
                                "nth_of_type": 1,
                            },
                            {
                                "tag_name": "div",
                                "attr__id": "__next",
                                "nth_child": 1,
                                "nth_of_type": 1,
                            },
                            {
                                "tag_name": "body",
                                "classes": ["chakra-ui-light"],
                                "attr__class": "chakra-ui-light",
                                "nth_child": 2,
                                "nth_of_type": 1,
                            },
                        ],
                        "token": "63eb4eea19c763c212bc444d",
                        "$session_id": "1878de47cc337dd-0ff3158333e013-1d525634-16a7f0-1878de47cc44210",
                        "$window_id": "1878df92f1428bf-0a01a1b024ea9d-1d525634-16a7f0-1878df92f153e7b",
                        "$pageview_id": "1878dfc3d441a2f-0321ef1c72bcde-1d525634-16a7f0-1878dfc3d454b62",
                    },
                ),
                PrecisionEvent(
                    datasourceId="63eb4eea19c763c212bc444d",
                    timestamp=datetime.fromtimestamp(1681714333.388),
                    userId="1876b24aecbe52-0fd97ea66a2cdf-1e525634-16a7f0-1876b24aecc171f",
                    provider="apperture",
                    eventName="$pageleave",
                    properties={
                        "$os": "Mac OS X",
                        "$browser": "Chrome",
                        "$device_type": "Desktop",
                        "$current_url": "https://app.staging.apperture.io/analytics/explore/63eb4eea19c763c212bc444d",
                        "$host": "app.staging.apperture.io",
                        "$pathname": "/analytics/explore/63eb4eea19c763c212bc444d",
                        "$browser_version": 112,
                        "$browser_language": "en-GB",
                        "$screen_height": 982,
                        "$screen_width": 1512,
                        "$viewport_height": 560,
                        "$viewport_width": 1512,
                        "$lib": "web",
                        "$lib_version": "1.50.4",
                        "$insert_id": "ph5rf1hs52ji9qgg",
                        "$time": 1681714333.388,
                        "distinct_id": "631821697fb64164bfa6609e",
                        "$device_id": "1876b24aecbe52-0fd97ea66a2cdf-1e525634-16a7f0-1876b24aecc171f",
                        "$referrer": "$direct",
                        "$referring_domain": "$direct",
                        "$user_id": "631821697fb64164bfa6609e",
                        "token": "63eb4eea19c763c212bc444d",
                        "$session_id": "1878de47cc337dd-0ff3158333e013-1d525634-16a7f0-1878de47cc44210",
                        "$window_id": "1878df92f1428bf-0a01a1b024ea9d-1d525634-16a7f0-1878df92f153e7b",
                        "$pageview_id": "1878dfc3d441a2f-0321ef1c72bcde-1d525634-16a7f0-1878dfc3d454b62",
                    },
                ),
                PrecisionEvent(
                    datasourceId="63eb4eea19c763c212bc444d",
                    timestamp=datetime.fromtimestamp(1681714333.495),
                    userId="1876b24aecbe52-0fd97ea66a2cdf-1e525634-16a7f0-1876b24aecc171f",
                    provider="apperture",
                    eventName="$pageview",
                    properties={
                        "$os": "Mac OS X",
                        "$browser": "Chrome",
                        "$device_type": "Desktop",
                        "$current_url": "https://app.staging.apperture.io/analytics/data/stream/63eb4eea19c763c212bc444d",
                        "$host": "app.staging.apperture.io",
                        "$pathname": "/analytics/data/stream/63eb4eea19c763c212bc444d",
                        "$browser_version": 112,
                        "$browser_language": "en-GB",
                        "$screen_height": 982,
                        "$screen_width": 1512,
                        "$viewport_height": 560,
                        "$viewport_width": 1512,
                        "$lib": "web",
                        "$lib_version": "1.50.4",
                        "$insert_id": "d3l8005xq80sysch",
                        "$time": 1681714333.495,
                        "distinct_id": "631821697fb64164bfa6609e",
                        "$device_id": "1876b24aecbe52-0fd97ea66a2cdf-1e525634-16a7f0-1876b24aecc171f",
                        "$referrer": "$direct",
                        "$referring_domain": "$direct",
                        "$user_id": "631821697fb64164bfa6609e",
                        "token": "63eb4eea19c763c212bc444d",
                        "$session_id": "1878de47cc337dd-0ff3158333e013-1d525634-16a7f0-1878de47cc44210",
                        "$window_id": "1878df92f1428bf-0a01a1b024ea9d-1d525634-16a7f0-1878df92f153e7b",
                        "$pageview_id": "1878dfc4737114e-08cffb238cfcc7-1d525634-16a7f0-1878dfc47382a0d",
                    },
                ),
            ]
        )
